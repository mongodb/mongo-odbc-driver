# Evergreen Project Config

# When a task that used to pass starts to fail
# Go through all versions that may have been skipped to detect
# when the task started failing
stepback: true

# Mark a failure as a system/bootstrap failure (purple box) rather than a task
# failure by default.
# Actual testing tasks are marked with `type: test`
command_type: system

# Protect ourselves against rogue test case, or curl gone wild, that runs forever
# 12 minutes is the longest we'll ever run
exec_timeout_secs: 3600 # 12 minutes is the longest we'll ever run

# What to do when evergreen hits the timeout (`post:` tasks are run automatically)
timeout:
  - command: shell.exec
    params:
      script: |
        ls -la

# Pull in sql-enginers-common-test-infra as a module
modules:
  - name: sql-engines-common-test-infra
    owner: mongodb
    repo: sql-engines-common-test-infra
    branch: main
    auto_update: true

include:
  - filename: evergreen/configs/mongodb_util.yml
    module: sql-engines-common-test-infra
  - filename: evergreen/configs/rust_util.yml
    module: sql-engines-common-test-infra
  - filename: evergreen/configs/ssdlc_util.yml
    module: sql-engines-common-test-infra

variables:
pre:
  - func: "fetch source"
  - func: "generate expansions"

post:
  - func: "upload start_adf logs"

functions:
  "generate third party licenses":
    - command: subprocess.exec
      params:
        binary: bash
        working_dir: mongosql-odbc-driver
        args:
          - "./evergreen/generate_licenses.sh"
        add_expansions_to_env: true

  "build odbc documentation":
    - command: subprocess.exec
      params:
        binary: bash
        working_dir: mongosql-odbc-driver
        args:
          - "./evergreen/make_docs.sh"
        add_expansions_to_env: true

  "upload odbc docs":
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/docs/MongoDB_ODBC_Guide.pdf
        remote_file: mongosql-odbc-driver/artifacts/docs/MongoDB_ODBC_Guide.pdf
        bucket: mciuploads
        permissions: public-read
        content_type: application/pdf

  "fetch for windows sign":
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/${MSI_FILENAME}
        local_file: mongosql-odbc-driver/installer/msi/${MSI_FILENAME}
        bucket: mciuploads

  "fetch for ubuntu sign":
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/${UBUNTU_FILENAME}
        local_file: mongosql-odbc-driver/installer/tgz/${UBUNTU_FILENAME}
        bucket: mciuploads

  "fetch source":
    - command: git.get_project
      params:
        directory: mongosql-odbc-driver
        revisions:
          sql-engines-common-test-infra: ${sql-engines-common-test-infra_rev}

  "generate expansions":
    - command: subprocess.exec
      params:
        binary: bash
        working_dir: mongosql-odbc-driver
        env:
          triggered_by_git_tag: ${triggered_by_git_tag}
        args:
          - "./evergreen/create-expansions.sh"
        add_expansions_to_env: true
    - command: expansions.update
      params:
        file: mongosql-odbc-driver/expansions.yml

  "generate github token":
    command: github.generate_token
    params:
      owner: 10gen
      repo: mongohouse
      expansion_name: github_token

  "generate SBOM":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        include_expansions_in_env:
          - SBOM_DIR
          - SBOM_LICENSES
          - SBOM_VULN
        script: |
          ${prepare_shell}
          echo ">>>> Install SBOM tool..."

          OS=$(uname)
          echo "OS=$OS"
          ARCH="$(uname -m)"
          echo "Arch=$ARCH"

          mkdir $SBOM_DIR

          echo "SBOM with vulnerabilities: $SBOM_LICENSES";
          echo "SBOM with license: $SBOM_VULN";
          echo "Final SBOM with all information: $SBOM_FINAL"

          # Install cargo-cyclonedx
          echo "-- Installing cargo-cyclonedx --"
          cargo install cargo-cyclonedx
          echo "------------------------------------"

          # Install Grype
          echo "-- Downloading Grype --"
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b $SBOM_DIR
          echo "------------------------------------"

          # Install CycloneDX CLI and JQ
          CYCLONE_URL="https://github.com/CycloneDX/cyclonedx-cli/releases/download/v0.25.0"
          JQ_URL="https://github.com/jqlang/jq/releases/download/jq-1.7.1"
          if [[ "$OS" = "Linux" ]]; then
            if [[ "$ARCH" = "x86_64" ]]; then
              CYCLONE_URL="$CYCLONE_URL/cyclonedx-linux-x64"
              JQ_URL="$JQ_URL/jq-linux-amd64"
            elif [ "$ARCH" = "arm64" ]; then
              CYCLONE_URL="$CYCLONE_URL/cyclonedx-linux-arm64"
              JQ_URL="$JQ_URL/jq-linux-arm64"
            fi
          elif [[ "$OS" = "Darwin" ]]; then
            if [[ "$ARCH" = "arm64" ]]; then
              CYCLONE_URL="$CYCLONE_URL/cyclonedx-osx-arm64"
              JQ_URL="$JQ_URL/jq-macos-arm64"
            else
              CYCLONE_URL="$CYCLONE_URL/cyclonedx-osx-x64"
              JQ_URL="$JQ_URL/jq-macos-amd64"
            fi
          else
            # Windows
            CYCLONE_URL="$CYCLONE_URL/cyclonedx-win-x64.exe"
            JQ_URL="$JQ_URL/jq-windows-amd64.exe"
          fi

          echo "-- Downloading CycloneDX CLI  for $OS-$ARCH $CYCLONE_URL --"
          curl -L -o $SBOM_DIR/cyclonedx-cli "$CYCLONE_URL" \
            --silent \
            --fail \
            --max-time 60 \
            --retry 5 \
            --retry-delay 0
          chmod +x ./$SBOM_DIR/cyclonedx-cli
          echo "------------------------------------"

          echo "-- Downloading JQ $JQ_URL --"
          curl -L -o $SBOM_DIR/jq "$JQ_URL" \
            --silent \
            --fail \
            --max-time 60 \
            --retry 5 \
            --retry-delay 0
          chmod +x ./$SBOM_DIR/jq
          echo "------------------------------------"
          echo "<<<< Done installing SBOM tools"

          echo ">>>> Generate SBOM..."
          echo "--  Generating SBOMs with the licenses information --"
          cargo cyclonedx --target all -v -f json
          echo "------------------------------------"

          echo "-- Merging info from both mongo-odbc-driver and win_setupgui because both are packaged libraries --"
          echo "./$SBOM_DIR/cyclonedx-cli merge --input-files ./odbc/mongo-odbc-driver.cdx.json ./win_setupgui/win_setupgui.cdx.json --output-format json --input-format json --group mongo-odbc-driver --name mongo-odbc-driver> $SBOM_LICENSES"
          ./$SBOM_DIR/cyclonedx-cli merge --input-files ./odbc/mongo-odbc-driver.cdx.json ./win_setupgui/win_setupgui.cdx.json --output-format json --input-format json --group mongo-odbc-driver --name mongo-odbc-driver> $SBOM_LICENSES
          echo "------------------------------------"

          echo "-- Generating SBOM with vulnerabilities information --"
          echo "./$SBOM_DIR/grype sbom:$SBOM_LICENSES -o cyclonedx-json > $SBOM_VULN"
          ./$SBOM_DIR/grype sbom:$SBOM_LICENSES -o cyclonedx-json > $SBOM_VULN
          echo "------------------------------------"

          echo "-- Merging the SBOMs with the licenses information and the SBOM with the  vulnerabilities information in $SBOM_FINAL --"

          temp_output="temp_output.json"
          if [[ -f "$temp_output" ]] ; then
              rm "$temp_output"
          fi
          touch $temp_output

          while IFS= read -r line
          do
            if [[ "$line" == *"purl"* ]]; then
              bash_purl=$(echo $line | cut -d '"' -f4)
              command=$(echo "./$SBOM_DIR/jq '.components[] | select(.purl == \"$bash_purl\").licenses' $SBOM_LICENSES | ./$SBOM_DIR/jq -s 'flatten(1)'")
              # Add the license information back in the augmented SBOM.
              licenseInfo=$(eval " $command")
              if [[ -z "$licenseInfo" ]]; then
                echo "\"licenses\" : []," >> $temp_output
              else
                echo "\"licenses\" : $licenseInfo," >> $temp_output
              fi
            fi
            echo "$line" >> $temp_output

          done < $SBOM_VULN
          echo "------------------------------------"

          echo "--  Adding the name of the team responsible for each dependency as required by Silk and format the json file --"
          echo "./$SBOM_DIR/jq '.components[].properties += [{\"name\": \"internal:team_responsible\", \"value\": \"Atlas SQL\"}]' $temp_output > $SBOM_FINAL"
          ./$SBOM_DIR/jq '.components[].properties += [{"name": "internal:team_responsible", "value": "Atlas SQL"}]' $temp_output > $SBOM_FINAL
          echo "------------------------------------"

          echo "-- Adding VEX info for vulnerabilities still present in SBOM--"
          IFS=','; for vuln_id in $ALLOW_VULNS; do
            echo "-- Updating SBOM with VEX info for vulnerability with id $vuln_id--"
            export VULN_ID=$vuln_id
            echo "jq --argjson vexinfo "$(<resources/ssdlc/$VULN_ID.analysis.json)" '(.vulnerabilities[] | select(.id == $ENV.VULN_ID)).analysis = ($vexinfo) ' $SBOM_FINAL > output.tmp && mv output.tmp $SBOM_FINAL"
            jq --argjson vexinfo "$(<resources/ssdlc/$VULN_ID.analysis.json)" '(.vulnerabilities[] | select(.id == $ENV.VULN_ID)).analysis = ($vexinfo) ' $SBOM_FINAL > output.tmp && mv output.tmp $SBOM_FINAL
            echo "--------"
          done
          echo "-----------------------------"
          echo "<<<< Done generating SBOM"
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_files_include_filter:
          - mongosql-odbc-driver/*.cdx.json
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/ssdlc/
        content_type: text/plain
        bucket: mciuploads
        permissions: public-read

  "augment SBOM":
    - command: ec2.assume_role
      display_name: Assume IAM role with permissions to pull Kondukto API token
      params:
        role_arn: ${kondukto_role_arn}
    - command: shell.exec
      display_name: Pull Kondukto API token from AWS Secrets Manager and write it to file
      params:
        silent: true
        shell: bash
        working_dir: mongosql-odbc-driver
        include_expansions_in_env: [AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_SESSION_TOKEN]
        script: |
          # use AWS CLI to get the Kondukto API token from AWS Secrets Manager
          kondukto_token=$(aws secretsmanager get-secret-value --secret-id "kondukto-token" --region "us-east-1" --query 'SecretString' --output text)
          if [ $? -ne 0 ]; then
              exit 1
          fi
          # set the KONDUKTO_TOKEN environment variable
          echo "KONDUKTO_TOKEN=$kondukto_token" > ${workdir}/kondukto_credentials.env
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}

          echo "SBOM_FINAL = $SBOM_FINAL"

          echo "-- Augmenting SBOM Lite --"
          docker run -i --platform="linux/amd64" --rm -v "$PWD":/pwd \
          --env-file ${workdir}/kondukto_credentials.env \
          artifactory.corp.mongodb.com/release-tools-container-registry-public-local/silkbomb:2.0 \
          augment --repo mongodb/mongo-odbc-driver --branch ${branch_name} --sbom-in /pwd/$SBOM_FINAL --sbom-out /pwd/${AUGMENTED_SBOM_FILENAME} --force
          echo "-------------------------------"
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/${AUGMENTED_SBOM_FILENAME}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/ssdlc/${AUGMENTED_SBOM_FILENAME}
        content_type: application/json
        bucket: mciuploads
        permissions: public-read

  "use latest mongosql version":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          
          # use the latest mongosql release tag
          set -o pipefail
          MONGOSQL_VERSION=$(git ls-remote --tags --refs https://github.com/mongodb/mongosql.git | grep -o 'refs/tags/v[0-9]*\.[0-9]*\.[0-9]*' | sed 's/refs\/tags\///' | sort -V | tail -n 1)
          if [ $? -ne 0 ] || [ -z "$MONGOSQL_VERSION" ] || [ "$MONGOSQL_VERSION" = "null" ] || [ "$MONGOSQL_VERSION" = "" ]; then
              echo "Error: Failed to fetch valid mongosql tags"
              exit 1
          fi
          echo "MONGOSQL_VERSION: $MONGOSQL_VERSION"

          # we need to set the versions of mongosql and agg-ast to be the same so we don't get inconsistencies

          if [[ "$(uname -s)" = "Darwin" ]]; then
            sed -i '' 's/\(mongosql = {.*\)branch = "main"\(.*}\)/\1tag = "'"$MONGOSQL_VERSION"'"\2/' core/Cargo.toml
          else
            sed -i "s/^\(mongosql = {.*\)branch = \"main\"\(.*}\)/\1tag = \"$MONGOSQL_VERSION\"\2/" core/Cargo.toml
          fi
          if [[ "$(uname -s)" = "Darwin" ]]; then
            sed -i '' 's/\(agg-ast = {.*\)branch = "main"\(.*}\)/\1tag = "'"$MONGOSQL_VERSION"'"\2/' core/Cargo.toml
          else
            sed -i "s/^\(agg-ast = {.*\)branch = \"main\"\(.*}\)/\1tag = \"$MONGOSQL_VERSION\"\2/" core/Cargo.toml
          fi

  "sign windows":
    - command: shell.exec
      type: system
      params:
        silent: true
        script: |
          docker login --username ${sql_engines_artifactory_username} --password ${sql_engines_artifactory_auth_token} ${release_tools_container_registry}
    - command: shell.exec
      type: system
      params:
        silent: true
        env:
          GRS_CONFIG_USER1_USERNAME: "${odbc_garasign_username}"
          GRS_CONFIG_USER1_PASSWORD: "${odbc_garasign_password}"
        working_dir: mongosql-odbc-driver/installer/msi
        script: |
          docker run \
            -e GRS_CONFIG_USER1_USERNAME \
            -e GRS_CONFIG_USER1_PASSWORD \
            --rm \
            -v $(pwd):$(pwd) -w $(pwd) \
            ${garasign_jsign_image} \
            /bin/bash -c "jsign -a ${authenticode_key_name} --replace --tsaurl http://timestamp.digicert.com -d SHA-256 ${MSI_FILENAME}"

          # Generating checksums
          if [ -e $msi_filename ]; then
            shasum -a 1 ${MSI_FILENAME} | tee ${MSI_FILENAME}.sha1
            shasum -a 256 ${MSI_FILENAME} | tee ${MSI_FILENAME}.sha256
            md5sum ${MSI_FILENAME} | tee ${MSI_FILENAME}.md5
          else
            echo "${MSI_FILENAME} does not exist. Skipping checksum generation"
          fi

  "sign ubuntu and verify signature":
    - command: shell.exec
      type: system
      params:
        silent: true
        script: |
          docker login --username ${sql_engines_artifactory_username} --password ${sql_engines_artifactory_auth_token} ${release_tools_container_registry}
    - command: shell.exec
      type: system
      params:
        silent: true
        env:
          GRS_CONFIG_USER1_USERNAME: "${odbc_garasign_username}"
          GRS_CONFIG_USER1_PASSWORD: "${odbc_garasign_password}"
        working_dir: mongosql-odbc-driver/installer/tgz
        script: |
          docker run \
            -e GRS_CONFIG_USER1_USERNAME \
            -e GRS_CONFIG_USER1_PASSWORD \
            --rm \
            -v $(pwd):$(pwd) -w $(pwd) \
            ${garasign_gpg_image} \
            /bin/bash -c "gpgloader && gpg --yes -v --armor -o ${UBUNTU_FILENAME}.sig --detach-sign ${UBUNTU_FILENAME}"
    - command: shell.exec
      type: system
      params:
        working_dir: mongosql-odbc-driver/installer/tgz
        silent: true
        env:
          GRS_CONFIG_USER1_USERNAME: "${odbc_garasign_username}"
          GRS_CONFIG_USER1_PASSWORD: "${odbc_garasign_password}"
        script: |
          docker run \
            -e GRS_CONFIG_USER1_USERNAME \
            -e GRS_CONFIG_USER1_PASSWORD \
            --rm \
            -v $(pwd):$(pwd) -w $(pwd) \
            ${garasign_gpg_image} \
            /bin/bash -c "gpgloader && gpg --verify ${UBUNTU_FILENAME}.sig ${UBUNTU_FILENAME}"

  "compile ubuntu and win release":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          # Compile release build with features if needed
          # if FEATURE_FLAGS is not empty, build with features
          if [[ "$FEATURE_FLAGS" != "" ]]; then
            cargo build --release --features $FEATURE_FLAGS
          else
            cargo build --release
          fi

          # Verify the version is the expected one from the driver perspective too
          cargo test api::get_info_tests::unit::driver_ver -- --nocapture

  "compile ubuntu and win debug":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}

          # Compile release build with features if needed
          if [[ "$FEATURE_FLAGS" != "" ]]; then
            cargo build --features $FEATURE_FLAGS
          else
            cargo build
          fi

  "compile ubuntu with asan":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          ~/.cargo/bin/rustup default nightly
          ~/.cargo/bin/rustup target add x86_64-unknown-linux-gnu

          export RUSTFLAGS="-Z sanitizer=address"

          if [[ "$FEATURE_FLAGS" != "" ]]; then
            cargo build --target x86_64-unknown-linux-gnu --features $FEATURE_FLAGS
          else
            cargo build --target x86_64-unknown-linux-gnu
          fi

  "compile release with debug info":
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          echo "env $(env)"
          # Build a release driver with debug information
          if [[ "$FEATURE_FLAGS" != "" ]]; then
            cargo build --release --features $FEATURE_FLAGS
          else
            cargo build --release
          fi

          export DRIVER_LIB_PATH=$PWD/target/release

          cat <<EOT >> expansions.yml
            export DRIVER_LIB_PATH="$DRIVER_LIB_PATH"
          EOT
    - command: expansions.update
      params:
        file: mongosql-odbc-driver/expansions.yml

  "compile macos release":
    - command: shell.exec
      type: test
      retry_on_failure: true
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          # Compile release build
          cargo build --release --features definitions/iodbc,cstr/utf32

          # Verify the version is the expected one from the driver perspective too
          cargo test api::get_info_tests::unit::driver_ver -- --nocapture

  "compile macos debug":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          # Compile debug build
          if [[ "$FEATURE_FLAGS" != "" ]]; then
            cargo build --features definitions/iodbc,cstr/utf32,$FEATURE_FLAGS
          else
            cargo build --features definitions/iodbc,cstr/utf32
          fi


  "compile macos release with debug info":
    - command: shell.exec
      retry_on_failure: true
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          echo "env $(env)"
          # Build a release driver with debug information
          if [[ "$FEATURE_FLAGS" != "" ]]; then
            cargo build --release --features definitions/iodbc,cstr/utf32,$FEATURE_FLAGS
          else
            cargo build --release --features definitions/iodbc,cstr/utf32
          fi
          export DRIVER_LIB_PATH=$PWD/target/release
          cat <<EOT >> expansions.yml
            export DRIVER_LIB_PATH="$DRIVER_LIB_PATH"
          EOT
    - command: expansions.update
      params:
        file: mongosql-odbc-driver/expansions.yml

  "build msi":
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/${AUGMENTED_SBOM_FILENAME}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/ssdlc/${AUGMENTED_SBOM_FILENAME}
        content_type: application/json
        bucket: mciuploads
        permissions: public-read
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}

          cp target/release/*.dll installer/msi
          cp ./THIRD_PARTY_LICENSES.txt ./README.md ./${AUGMENTED_SBOM_FILENAME} installer/msi
          cd installer/msi
          if [[ "$release_version" == "snapshot" ]]; then
              MINOR_VERSION="0.1"
              VERSION_LABEL="0.1.0"
          else
              MINOR_VERSION=$(echo "$release_version" | cut -d '.' -f 1-2)
              VERSION_LABEL="$release_version"
          fi

          # unfortunately, using a variable to hold the path to powershell
          # seems to not work properly with evergreen's bash
          /cygdrive/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe\
              -NoProfile\
              -NoLogo\
              -NonInteractive\
              -ExecutionPolicy ByPass\
              -File ./build-msi.ps1\
              -Arch x64\
              -Version "$MINOR_VERSION"\
              -VersionLabel "$VERSION_LABEL"\

  "build dmg":
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/${AUGMENTED_SBOM_FILENAME}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/ssdlc/${AUGMENTED_SBOM_FILENAME}
        content_type: application/json
        bucket: mciuploads
        permissions: public-read
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}

          cp target/release/*.dylib installer/dmg
          cp target/release/macos_postinstall installer/dmg
          cd installer/dmg
          if [ "$release_version" == "snapshot" ]; then
              MINOR_VERSION="0.1"
          else
              MINOR_VERSION=$(echo "$release_version" | sed 's|\([0-9]\+[.][0-9]\+\)[.][0-9]\+|\1|')
          fi
          ./build-dmg.sh "$MINOR_VERSION"

  "mciuploads release artifacts":
    - command: s3.put
      params:
        build_variants:
          - windows-64
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/target/release/atsql.dll
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/atsql.dll
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        build_variants:
          - windows-64
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/installer/msi/mongoodbc.msi
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/${MSI_FILENAME}
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        build_variants:
          - windows-64
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/target/release/atsqls.dll
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/atsqls.dll
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        build_variants:
          - windows-64
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/target/release/atsql.pdb
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/atsql.pdb
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        build_variants:
          - ubuntu2204
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/target/release/libatsql.so
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/libatsql.so
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        build_variants:
          - ubuntu2204
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/release/${UBUNTU_FILENAME}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/${UBUNTU_FILENAME}
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        build_variants:
          - macos-arm
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/target/release/libatsql.dylib
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/libatsql.dylib
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        build_variants:
          - macos-arm
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/installer/dmg/mongoodbc.dmg
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/mongoodbc.dmg
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream

  "upload signed windows artifacts":
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/windows-64/release/mongoodbc-signed.msi
        local_file: mongosql-odbc-driver/installer/msi/${MSI_FILENAME}
        bucket: mciuploads
        permissions: public-read
        display_name: mongoodbc-signed.msi
        content_type: application/octet-stream
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/windows-64/release/mongoodbc-signed.msi.sha256
        local_file: mongosql-odbc-driver/installer/msi/${MSI_FILENAME}.sha256
        bucket: mciuploads
        permissions: public-read
        display_name: mongoodbc-signed.msi.sha256
        content_type: application/octet-stream

  "upload ubuntu sig file":
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/ubuntu2204/release/${UBUNTU_FILENAME}.sig
        local_file: mongosql-odbc-driver/installer/tgz/${UBUNTU_FILENAME}.sig
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream

  "upload release":
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/docs/MongoDB_ODBC_Guide.pdf
        local_file: mongosql-odbc-driver/release/docs/MongoDB_ODBC_Guide.pdf
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/release/docs/MongoDB_ODBC_Guide.pdf
        remote_file: mongodb-odbc-driver/docs/MongoDB_ODBC_Guide.pdf
        bucket: translators-connectors-releases
        permissions: public-read
        skip_existing: false
        content_type: application/pdf
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/windows-64/release/mongoodbc-signed.msi
        local_file: mongosql-odbc-driver/release/mongoodbc-signed.msi
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/release/mongoodbc-signed.msi
        remote_file: ${WINDOWS_INSTALLER_PATH}
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
        display_name: ${MSI_FILENAME}
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/windows-64/release/mongoodbc-signed.msi.sha256
        local_file: mongosql-odbc-driver/release/mongoodbc-signed.msi.sha256
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/release/mongoodbc-signed.msi.sha256
        remote_file: ${WINDOWS_INSTALLER_PATH}.sha256
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
        display_name: ${MSI_FILENAME}.sha256
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/windows-64/release/atsql.dll
        local_file: mongosql-odbc-driver/release/atsql.dll
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/release/atsql.dll
        remote_file: mongosql-odbc-driver/windows/${release_version}/release/atsql.dll
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/windows-64/release/atsqls.dll
        local_file: mongosql-odbc-driver/release/atsqls.dll
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/release/atsqls.dll
        remote_file: mongosql-odbc-driver/windows/${release_version}/release/atsqls.dll
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/windows-64/release/atsql.pdb
        local_file: mongosql-odbc-driver/release/atsql.pdb
        bucket: mciuploads
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/release/atsql.pdb
        remote_file: mongosql-odbc-driver/windows/${release_version}/release/atsql.pdb
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/ubuntu2204/release/${UBUNTU_FILENAME}
        local_file: mongosql-odbc-driver/target/release/${UBUNTU_FILENAME}
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/target/release/${UBUNTU_FILENAME}
        remote_file: ${UBUNTU2204_INSTALLER_PATH}
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/ubuntu2204/release/${UBUNTU_FILENAME}.sig
        local_file: mongosql-odbc-driver/target/release/${UBUNTU_FILENAME}.sig
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/target/release/${UBUNTU_FILENAME}.sig
        remote_file: mongosql-odbc-driver/ubuntu2204/${release_version}/release/${UBUNTU_FILENAME}.sig
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/ubuntu2204/release/libatsql.so
        local_file: mongosql-odbc-driver/target/release/libatsql.so
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/target/release/libatsql.so
        remote_file: mongosql-odbc-driver/ubuntu2204/${release_version}/release/libatsql.so
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream

  "download artifact":
    - command: s3.get
      params:
        build_variants:
          - windows-64
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/atsql.dll
        local_file: mongosql-odbc-driver/atsql.dll
        bucket: mciuploads
    - command: s3.get
      params:
        build_variants:
          - windows-64
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/atsqls.dll
        local_file: mongosql-odbc-driver/atsqls.dll
        bucket: mciuploads
    - command: s3.get
      params:
        build_variants:
          - ubuntu2204
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/${build_variant}/release/libatsql.so
        local_file: mongosql-odbc-driver/libatsql.so
        bucket: mciuploads

  "tar linux artifacts":
    - command: s3.get
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/${AUGMENTED_SBOM_FILENAME}
        remote_file: mongosql-odbc-driver/artifacts/${version_id}/ssdlc/${AUGMENTED_SBOM_FILENAME}
        content_type: application/json
        bucket: mciuploads
        permissions: public-read
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}

          mkdir -p release/mongoodbc/bin
          cp target/release/*.so release/mongoodbc/bin/
          cp ./LICENSE ./README.md ./${AUGMENTED_SBOM_FILENAME} release/mongoodbc/
          cd release
          tar -czvf $UBUNTU_FILENAME mongoodbc/

  "setup driver on Windows":
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          echo "Minor version: $MINOR_VERSION"
          sed -i 's@%DRIVER_DLL_PATH%@'"$(echo "$(cygpath -w $(pwd))" | sed s',\\,\\\\\\\\,g')"'@' setup/setupDSN.reg
          sed -i 's@%ADF_TEST_USER%@'"$(echo "${adf_test_local_user}" | sed s',\\,\\\\\\\\,g')"'@' setup/setupDSN.reg
          sed -i 's@%ADF_TEST_PWD%@'"$(echo "${adf_test_local_pwd}" | sed s',\\,\\\\\\\\,g')"'@' setup/setupDSN.reg
          sed -i 's@%ADF_TEST_URI%@'"$(echo "${adf_test_uri}" | sed s',\\,\\\\\\\\,g')"'@' setup/setupDSN.reg
          sed -i 's@%ADF_TEST_DB%@'"$(echo "${adf_test_local_db}" | sed s',\\,\\\\\\\\,g')"'@' setup/setupDSN.reg
          reg import "setup\setupDSN.reg"
          echo "----- Registry entries after setup ----"
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\ODBC\ODBCINST.INI\ODBC Drivers" -s 2> /dev/null
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\ODBC\ODBCINST.INI\ODBC Drivers" -s 2> /dev/null
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\ODBC\ODBCINST.INI\MongoDB Atlas SQL ODBC Driver" -s
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\ODBC\ODBCINST.INI\MongoDB Atlas SQL ODBC Driver" -s 2> /dev/null
          echo "-------------------------"

  "setup driver with UnixODBC":
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          echo "-----   Setup driver with Unix ODBC   -----"
          # DRIVER_LIB_PATH should have been set by the compile task
          echo "DRIVER_LIB_PATH = $DRIVER_LIB_PATH"
          if [ ! -d  "$DRIVER_LIB_PATH" ]; then
            echo "$DRIVER_LIB_PATH directory does not exist. Built targets are:"
            ls ${DRIVER_LIB_PATH%/*}
          fi
          sed -i "s,%DRIVER_LIB_PATH%,$DRIVER_LIB_PATH,g" setup/odbcinst.ini
          echo "-------------------------"
          cat setup/odbcinst.ini
          echo "-------------------------"
          echo "----- DSN Setup -----"
          sed -i "s,%DRIVER_LIB_PATH%,$DRIVER_LIB_PATH,g" setup/odbc.ini
          sed -i "s,%ADF_TEST_DB%,${adf_test_local_db},g" setup/odbc.ini
          sed -i "s,%ADF_TEST_USER%,${adf_test_local_user},g" setup/odbc.ini
          sed -i "s,%ADF_TEST_PWD%,${adf_test_local_pwd},g" setup/odbc.ini
          sed -i "s,%ADF_TEST_HOST%,${adf_test_host},g" setup/odbc.ini
          cp setup/odbc.ini ~/.odbc.ini
          echo "---- END DSN Setup ----"

  "setup driver with iODBC":
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          echo "-----   Setup driver with iODBC   -----"
          # DRIVER_LIB_PATH should have been set by the compile task
          echo "DRIVER_LIB_PATH = $DRIVER_LIB_PATH"
          if [ ! -d  "$DRIVER_LIB_PATH" ]; then
            echo "$DRIVER_LIB_PATH directory does not exist. Built targets are:"
            ls ${DRIVER_LIB_PATH%/*}
          fi
          sed -i.bu "s,%DRIVER_LIB_PATH%,$DRIVER_LIB_PATH,g" setup/iodbcinst.ini
          echo "-------------------------"
          cat setup/iodbcinst.ini
          echo "-------------------------"
          echo "----- DSN Setup -----"
          sed -i.bu "s,%DRIVER_LIB_PATH%,$DRIVER_LIB_PATH,g" setup/iodbc.ini
          sed -i.bu "s,%ADF_TEST_DB%,${adf_test_local_db},g" setup/iodbc.ini
          sed -i.bu "s,%ADF_TEST_USER%,${adf_test_local_user},g" setup/iodbc.ini
          sed -i.bu "s,%ADF_TEST_PWD%,${adf_test_local_pwd},g" setup/iodbc.ini
          sed -i.bu "s,%ADF_TEST_HOST%,${adf_test_host},g" setup/iodbc.ini
          echo "---- END DSN Setup ----"

          cat <<EOT >> expansions.yml
            export ODBCINSTINI="$ODBCSYSINI/iodbcinst.ini"
            export ODBCINI="$ODBCSYSINI/iodbc.ini"
          EOT
    - command: expansions.update
      params:
        file: mongosql-odbc-driver/expansions.yml

  "setup crash dump collection":
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          mkdir $DUMP_PATH
          set +e
          echo "----- Registry entries before setup ----"
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps"
          REGQUERY_EXITCODE=$?
          if [ $REGQUERY_EXITCODE -eq 0 ]; then
            # The key exists, save the values
            echo "Saving values in $LOCAL_DUMP_ORIGINAL_REG_VAL"
            reg export "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps" $LOCAL_DUMP_ORIGINAL_REG_VAL
            echo "----- Saved entries ----"
            cat $LOCAL_DUMP_ORIGINAL_REG_VAL
            echo "-------------------------"
          fi
          set -e
          sed -i 's@%$DUMP_PATH%@'"$(echo "$(cygpath -w $(pwd))\\$DUMP_FOLDER" | sed s',\\,\\\\\\\\,g')"'@' setup/setup_dumps_collection.reg
          echo "----- setup_dumps_collection.reg content -----"
          cat setup/setup_dumps_collection.reg
          echo "-------------------------"
          reg import "setup\setup_dumps_collection.reg"
          echo "----- Registry entries after setup ----"
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps" -s 2> /dev/null
          echo "-------------------------"
          echo "App Data = $AppData"

  "clean-up driver on Windows":
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          if [ 'windows-32' == '${build_variant}' ]; then
            sed -i 's@SOFTWARE@'"SOFTWARE\\\\Wow6432Node"'@' setup/cleanup_driver.reg
          fi
          reg import "setup\cleanup_driver.reg"
          echo "----- Registry entries after clean-up----"
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\ODBC\ODBCINST.INI\ODBC Drivers" -s 2> /dev/null
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\ODBC\ODBCINST.INI\ODBC Drivers" -s 2> /dev/null
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\ODBC\ODBCINST.INI\MongoDB Atlas SQL ODBC Driver" -s 2> /dev/null
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\ODBC\ODBCINST.INI\MongoDB Atlas SQL ODBC Driver" -s 2> /dev/null
          echo "-------------------------"

  "clean-up crash dump collection":
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          set +e
          # See what crash dump has been created. Checking the default path just in case
          echo "----- Dumps collected stored in $DUMP_PATH ----"
          ls -lrt $DUMP_PATH
          echo "-------------------------"
          echo "----- Dumps collected stored in the default dump folder %LOCALAPPDATA%\CrashDumps ----"
          ls -lrt /cygdrive/c/Users/Administrator/AppData/Local/CrashDumps
          echo "-------------------------"
          echo "----- Registry entries before clean-up ----"
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps"
          echo "-------------------------"
          if [ -f "$LOCAL_DUMP_ORIGINAL_REG_VAL" ]; then
            echo "Resetting initial registry values"
            cat $LOCAL_DUMP_ORIGINAL_REG_VAL
            reg import $LOCAL_DUMP_ORIGINAL_REG_VAL
          else
            echo "Resetting initial registry values - Deleting entry"
            reg import setup/cleanup_dumps_collection.reg
          fi
          EXITCODE=$?
          echo "----- Registry entries after clean-up ----"
          reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps" -s 2> /dev/null
          echo "-------------------------"
          exit $EXITCODE

  "install iODBC":
    - command: shell.exec
      type: system
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          mkdir -p "$INSTALLED_ODBC_PATH"
          cd installed_odbc
          echo "downloading iODBC"
          iODBC_dir=libiodbc-3.52.15
          curl -LO "https://github.com/openlink/iODBC/releases/download/v3.52.15/$iODBC_dir.tar.gz" \
            --silent \
            --fail \
            --max-time 60 \
            --retry 5 \
            --retry-delay 0
          tar xf "$iODBC_dir.tar.gz"
          cd "$iODBC_dir"
          ./configure --prefix="$INSTALLED_ODBC_PATH"
          make
          make install

  "install unix odbc":
    - command: shell.exec
      type: system
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          mkdir -p "$INSTALLED_ODBC_PATH"
          cd installed_odbc
          echo "downloading unixODBC"
          unixODBC_dir=unixODBC-2.3.6
          curl -O "http://noexpire.s3.amazonaws.com/sqlproxy/binary/linux/unixODBC-2.3.6.tar.gz" \
            --silent \
            --fail \
            --max-time 60 \
            --retry 5 \
            --retry-delay 0
          tar xf "$unixODBC_dir.tar.gz"
          cd "$unixODBC_dir"
          ./configure --prefix="$INSTALLED_ODBC_PATH" --with-pic
          make
          make install

  ##############################
  # Test functions and helpers #
  ##############################
  "decompress testdata files":
    - command: subprocess.exec
      params:
        binary: bash
        working_dir: mongosql-odbc-driver
        args:
          - "./evergreen/decompress_testdata_files.sh"

  "run windows unit tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          RUST_BACKTRACE=1 cargo test unit

  "run windows integration tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        env:
          GITHUB_TOKEN: "${github_token}"
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          set +e
          export RUST_BACKTRACE=1
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh start &&
          cargo run --manifest-path "$COMMON_TEST_INFRA_DIR/Cargo.toml" --bin data-loader -- \
            --mongod-uri mongodb://localhost:28017 \
            --adf-uri "mongodb://${adf_test_local_user}:${adf_test_local_pwd}@localhost:27017" \
            -d "./resources/integration_test/testdata" &&
          cargo test integration -- --nocapture &&
          # Logger tests will delete existing logs, in order to avoid destroying important logs from our local environment
          # the test is feature gated and will only run on evergreen.
          # Logger tests also have to run in isolation because other tests running simultaneously will "pollute" the log file the logger tests analyse.
          cargo test --test connection_tests integration::test_driver_log_level --features evergreen_tests -- --nocapture
          EXITCODE=$?
          echo "****** ls -l ./target/debug/deps *******"
          ls -l ./target/debug/deps
          echo "****************************************"
          # The execution terminated with a segfault
          if [ $EXITCODE -eq 139 ]; then
            # Compress the sources and pdbs so that we'll have everything for debugging available in Evergreen after a run
            SOURCES_FOLDERS=$(find $(pwd) -path '*/src' | tr '\n' ' ')
            PDB_FILES=$(find $(pwd) -path '*/target/debug/deps/*test*.pdb' | tr '\n' ' ')
            echo "tar czvf "$DUMP_PATH/$MONGOODBC_DEBUGGING_INFO_ARCHIVE.tar.gz" $SOURCES_FOLDERS $PDB_FILES"
            tar czvf "$DUMP_PATH/$MONGOODBC_DEBUGGING_INFO_ARCHIVE.tar.gz" $SOURCES_FOLDERS $PDB_FILES

            echo "ls -l $DUMP_PATH"
            ls -l $DUMP_PATH
          fi
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh stop
          exit $EXITCODE

  "run windows result set test":
    command: shell.exec
    type: test
    params:
      shell: bash
      env:
        GITHUB_TOKEN: "${github_token}"
      working_dir: mongosql-odbc-driver
      script: |
        ${prepare_shell}
        set +e
        export RUST_BACKTRACE=1
        $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh start &&
        cargo run --manifest-path "$COMMON_TEST_INFRA_DIR/Cargo.toml" --bin data-loader -- \
          --mongod-uri mongodb://localhost:28017 \
          --adf-uri "mongodb://${adf_test_local_user}:${adf_test_local_pwd}@localhost:27017" \
          -d "./resources/integration_test/testdata" &&
        cargo test --package integration_test --lib test_runner --features integration_test/result_set
        EXITCODE=$?
        # The execution terminated with a segfault
        if [ $EXITCODE -eq 139 ]; then
            # Compress the sources and pdbs so that we'll have everything for debugging available in Evergreen after a run
            SOURCES_FOLDERS=$(find $(pwd) -path '*/src' | tr '\n' ' ')
            PDB_FILES=$(find $(pwd) -path '*/target/debug/deps/*test*.pdb' | tr '\n' ' ')
            echo "tar czvf "$DUMP_PATH/$MONGOODBC_DEBUGGING_INFO_ARCHIVE.tar.gz" $SOURCES_FOLDERS $PDB_FILES"
            tar czvf "$DUMP_PATH/$MONGOODBC_DEBUGGING_INFO_ARCHIVE.tar.gz" $SOURCES_FOLDERS $PDB_FILES
        fi
        $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh stop
        exit $EXITCODE

  "run ubuntu unit tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          ~/.cargo/bin/rustup default stable

          # we only run ubuntu on the unit tests for now
          cargo test unit

  "run ubuntu rfc8252_http_server tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          ~/.cargo/bin/rustup default stable

          # run the rfc8252_http_server tests
          cargo test rfc8252_http_server -- --test-threads=1

  "run ubuntu integration tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        env:
          GITHUB_TOKEN: "${github_token}"
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          set +e
          echo "-------- ODBC related env variable ----------"
          echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH"
          echo "LIBRARY_PATH = $LIBRARY_PATH"
          echo "ODBCSYSINI = $ODBCSYSINI"
          echo "----------------------------------------------"

          ~/.cargo/bin/rustup default stable

          export RUST_BACKTRACE=1
          # Start a local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh start &&
          cargo run --manifest-path "$COMMON_TEST_INFRA_DIR/Cargo.toml" --bin data-loader -- \
            --mongod-uri mongodb://localhost:28017 \
            --adf-uri "mongodb://${adf_test_local_user}:${adf_test_local_pwd}@localhost:27017" \
            -d "./resources/integration_test/testdata" &&

          # Run integration tests with ubuntu
          cargo test integration -- --nocapture &&
          # Logger tests will delete existing logs, in order to avoid destroying important logs from our local environment
          # the test is feature gated and will only run on evergreen.
          # Logger tests also have to run in isolation because other tests running simultaneously will "pollute" the log file the logger tests analyse.
          cargo test --test connection_tests integration::test_driver_log_level --features evergreen_tests -- --nocapture

          EXITCODE=$?

          # Stop the local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh stop
          exit $EXITCODE

  "run ubuntu mongosqltranslate integration tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          cargo build --release
          cargo test mongosqltranslate_tests -- --nocapture

  "run ubuntu cluster type integration tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}

          set +e

          mdb_version_com="mongodb-linux-x86_64-ubuntu2204-7.0.14"
          mdb_version_ent="mongodb-linux-x86_64-enterprise-ubuntu2204-7.0.14"
          arch="x64"

          # Start MongoDB instances
          ./resources/start_local_mdb.sh $mdb_version_com $mdb_version_ent $arch

          # Enterprise test
          cargo test --features cluster_type_tests -- cluster_type::test_determine_cluster_type_enterprise_succeeds --nocapture
          ENTERPRISE_MSQL_EXITCODE=$?

          # Community test
          cargo test --features cluster_type_tests -- cluster_type::test_determine_cluster_type_community_fails --nocapture
          COMMUNITY_MSQL_EXITCODE=$?

          # Stop MongoDB instances
          pkill mongod

          if [ $ENTERPRISE_MSQL_EXITCODE -eq 0 ] && [ $COMMUNITY_MSQL_EXITCODE -eq 0 ] ; then
            OVERALL_EXITCODE=0
          else
            OVERALL_EXITCODE=1
          fi

          echo "Cluster test results:"
          echo "Enterprise mongosql test exit code: $ENTERPRISE_MSQL_EXITCODE"
          echo "Community mongosql test exit code: $COMMUNITY_MSQL_EXITCODE"
          echo "Overall exit code: $OVERALL_EXITCODE"

          set -e

          exit $OVERALL_EXITCODE


  "run ubuntu result-set tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        env:
          GITHUB_TOKEN: "${github_token}"
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          set +e
          echo "-------- ODBC related env variable ----------"
          echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH"
          echo "LIBRARY_PATH = $LIBRARY_PATH"
          echo "ODBCSYSINI = $ODBCSYSINI"
          echo "----------------------------------------------"

          ~/.cargo/bin/rustup default stable

          export RUST_BACKTRACE=1
          # Start a local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh start &&
          cargo run --manifest-path "$COMMON_TEST_INFRA_DIR/Cargo.toml" --bin data-loader -- \
            --mongod-uri mongodb://localhost:28017 \
            --adf-uri "mongodb://${adf_test_local_user}:${adf_test_local_pwd}@localhost:27017" \
            -d "./resources/integration_test/testdata" &&

          # Run integration tests with ubuntu
          cargo test --package integration_test --lib test_runner --features integration_test/result_set
          EXITCODE=$?

          # Stop the local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh stop
          exit $EXITCODE

  "run macos result-set tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        env:
          GITHUB_TOKEN: "${github_token}"
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          set +e
          echo "-------- ODBC related env variable ----------"
          echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH"
          echo "LIBRARY_PATH = $LIBRARY_PATH"
          echo "ODBCINSTINI = $ODBCINSTINI"
          echo "----------------------------------------------"

          ~/.cargo/bin/rustup default stable

          export RUST_BACKTRACE=1
          # Start a local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh start &&
          cargo run --manifest-path "$COMMON_TEST_INFRA_DIR/Cargo.toml" --bin data-loader -- \
            --mongod-uri mongodb://localhost:28017 \
            --adf-uri "mongodb://${adf_test_local_user}:${adf_test_local_pwd}@localhost:27017" \
            -d "./resources/integration_test/testdata" &&

          # Run integration tests with macos
          cargo test --package integration_test --lib test_runner --features definitions/iodbc,cstr/utf32,integration_test/result_set
          EXITCODE=$?

          # Stop the local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh stop
          exit $EXITCODE

  "run macos unit tests":
    - command: shell.exec
      type: test
      retry_on_failure: true
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          ~/.cargo/bin/rustup default stable

          cargo test unit

  "run macos integration tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        env:
          GITHUB_TOKEN: "${github_token}"
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          set +e
          echo "-------- ODBC related env variable ----------"
          echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH"
          echo "LIBRARY_PATH = $LIBRARY_PATH"
          echo "ODBCINSTINI = $ODBCINSTINI"
          echo "----------------------------------------------"

          ~/.cargo/bin/rustup default stable

          export RUST_BACKTRACE=1
          # Start a local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh start &&
          cargo run --manifest-path "$COMMON_TEST_INFRA_DIR/Cargo.toml" --bin data-loader -- \
            --mongod-uri mongodb://localhost:28017 \
            --adf-uri "mongodb://${adf_test_local_user}:${adf_test_local_pwd}@localhost:27017" \
            -d "./resources/integration_test/testdata" &&

          # Run integration tests with macos
          cargo test --features definitions/iodbc,cstr/utf32 integration -- --nocapture &&
          # Logger tests will delete existing logs, in order to avoid destroying important logs from our local environment
          # the test is feature gated and will only run on evergreen.
          # Logger tests also have to run in isolation because other tests running simultaneously will "pollute" the log file the logger tests analyse.
          cargo test --test connection_tests integration::test_driver_log_level --features evergreen_tests,definitions/iodbc,cstr/utf32 -- --nocapture
          EXITCODE=$?

          # Stop the local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh stop
          exit $EXITCODE

  "run asan unit tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          ~/.cargo/bin/rustup default nightly
          ~/.cargo/bin/rustup target add x86_64-unknown-linux-gnu

          export RUSTFLAGS="-Z sanitizer=leak"
          # we only run asan on the unit tests for now
          cargo test --target x86_64-unknown-linux-gnu unit

  "run asan integration tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        env:
          GITHUB_TOKEN: "${github_token}"
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          set +e
          echo "-------- ODBC related env variable ----------"
          echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH"
          echo "LIBRARY_PATH = $LIBRARY_PATH"
          echo "ODBCSYSINI = $ODBCSYSINI"
          echo "----------------------------------------------"

          export RUSTFLAGS="-Z sanitizer=leak"
          export RUST_BACKTRACE=1
          echo "env $(env)"

          ~/.cargo/bin/rustup default nightly
          ~/.cargo/bin/rustup target add x86_64-unknown-linux-gnu

          # Start a local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh start &&
          cargo run --manifest-path "$COMMON_TEST_INFRA_DIR/Cargo.toml" --bin data-loader -- \
            --mongod-uri mongodb://localhost:28017 \
            --adf-uri "mongodb://${adf_test_local_user}:${adf_test_local_pwd}@localhost:27017" \
            -d "./resources/integration_test/testdata" &&

          # Run integration tests with asan
          cargo test --target x86_64-unknown-linux-gnu integration -- --nocapture &&
          # Logger tests will delete existing logs, in order to avoid destroying important logs from our local environment
          # the test is feature gated and will only run on evergreen.
          # Logger tests also have to run in isolation because other tests running simultaneously will "pollute" the log file the logger tests analyse.
          cargo test --target x86_64-unknown-linux-gnu --test connection_tests integration::test_driver_log_level --features evergreen_tests -- --nocapture
          EXITCODE=$?

          # Stop the local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh stop
          exit $EXITCODE

  "run asan result-set tests":
    - command: shell.exec
      type: test
      params:
        shell: bash
        env:
          GITHUB_TOKEN: "${github_token}"
        working_dir: mongosql-odbc-driver
        script: |
          ${prepare_shell}
          set +e
          echo "-------- ODBC related env variable ----------"
          echo "LD_LIBRARY_PATH = $LD_LIBRARY_PATH"
          echo "LIBRARY_PATH = $LIBRARY_PATH"
          echo "ODBCSYSINI = $ODBCSYSINI"
          echo "----------------------------------------------"

          ~/.cargo/bin/rustup default nightly
          ~/.cargo/bin/rustup target add x86_64-unknown-linux-gnu
          export RUSTFLAGS="-Z sanitizer=leak"

          export RUST_BACKTRACE=1
          # Start a local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh start &&
          cargo run --manifest-path "$COMMON_TEST_INFRA_DIR/Cargo.toml" --bin data-loader -- \
            --mongod-uri mongodb://localhost:28017 \
            --adf-uri "mongodb://${adf_test_local_user}:${adf_test_local_pwd}@localhost:27017" \
            -d "./resources/integration_test/testdata" &&

          # Run integration tests with asan
          cargo test --target x86_64-unknown-linux-gnu --package integration_test --lib test_runner --features integration_test/result_set
          EXITCODE=$?

          # Stop the local ADF
          $COMMON_TEST_INFRA_DIR/test-environment/run_adf.sh stop
          exit $EXITCODE

  "upload start_adf logs":
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/local_adf/logs/mongohoused.log
        remote_file: mongosql-odbc-driver/artifacts/logs/${version_id}/${build_variant}/mongohoused.log
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: mongosql-odbc-driver/local_adf/logs/mongodb_test.log
        remote_file: mongosql-odbc-driver/artifacts/logs/${version_id}/${build_variant}/mongodb_test.log
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream

  "upload crash debugging info":
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_files_include_filter_prefix: mongosql-odbc-driver/dumps
        local_files_include_filter:
          - "*.dmp"
          - "*.tar.gz"
        remote_file: mongosql-odbc-driver/artifacts/logs/${version_id}/${build_variant}/
        bucket: mciuploads
        permissions: public-read
        content_type: application/octet-stream
        display_name: crash-dump-
  
  "trace artifacts":
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver
        script: |
          mkdir papertrail
    - command: s3.get
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/papertrail/${MSI_FILENAME}
        remote_file: ${WINDOWS_INSTALLER_PATH}
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
    - command: s3.get
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/papertrail/${UBUNTU_FILENAME}
        remote_file: ${UBUNTU2204_INSTALLER_PATH}
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/octet-stream
    - command: papertrail.trace
      params:
        work_dir: mongosql-odbc-driver
        key_id: ${papertrail_id}
        secret_key: ${papertrail_key}
        product: mongo-odbc-driver
        version: ${release_version}
        filenames:
          - papertrail/*

  "update download center feed":
    # Download the current json feed used by the download center
    - command: s3.get
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        remote_file: mongosql-odbc-driver/mongo-odbc-downloads.json
        local_file: mongosql-odbc-driver/resources/download-center/mongo-odbc-downloads.json
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/json
    # Update the file, adding the latest release
    - command: shell.exec
      params:
        shell: bash
        working_dir: mongosql-odbc-driver/resources/download-center/
        script: |
          ${prepare_shell}
          # Make sure to only allow releases from the trunk of the project. If the name changes,
          # this will need be updated.
          if [[ $(git branch --show-current) != 'main' ]]; then
             echo "Updating the download center feed should only run on the main branch. Current branch: $(git branch --show-current). Exiting."
             exit 0
          fi
          # Update the template to generate the feed for this release
          sed -i 's@{release_version}@'${release_version}'@' mongo-odbc-downloads_template.json
          sed -i 's@{WINDOWS_INSTALLER_PATH}@'${WINDOWS_INSTALLER_PATH}'@' mongo-odbc-downloads_template.json
          sed -i 's@{UBUNTU2204_INSTALLER_PATH}@'${UBUNTU2204_INSTALLER_PATH}'@' mongo-odbc-downloads_template.json
          echo "--------- New release object ----------------"
          cat mongo-odbc-downloads_template.json
          echo "---------------------------------------------"
          NEW_VERSION=$(cat mongo-odbc-downloads_template.json)

          # The task runs on the variant used for Release (Ubuntu). Download the Linux build of JQ
          curl -L -o jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \
            --silent \
            --fail \
            --max-time 60 \
            --retry 5 \
            --retry-delay 0

          chmod +x jq

          # Add the new release, sort by version and reverse the array
          jq --argjson new_version "$NEW_VERSION" '.versions += [ $new_version ] | .versions |= sort_by(.version) | .versions |= reverse' mongo-odbc-downloads.json > mongo-odbc-downloads_updated.json

          echo "----------- Updated download list -------------"
          cat mongo-odbc-downloads_updated.json
          echo "-----------------------------------------------"
    # Re-upload the updated file
    - command: s3.put
      params:
        aws_key: ${release_aws_key}
        aws_secret: ${release_aws_secret}
        local_file: mongosql-odbc-driver/resources/download-center/mongo-odbc-downloads_updated.json
        remote_file: mongosql-odbc-driver/mongo-odbc-downloads.json
        bucket: translators-connectors-releases
        permissions: public-read
        content_type: application/json

tasks:
  - name: make-odbc-docs
    depends_on:
      - name: compile
    commands:
      - func: "build odbc documentation"
        run_on: ubuntu2004-large
      - func: "upload odbc docs"

  - name: sbom
    commands:
      - func: "install rust toolchain"
      - func: "set and check packages version"
        vars:
          cargo_file: "odbc/Cargo.toml"
          package_name: "odbc"
      - func: "use latest mongosql version"
      - func: "create ssdlc expansions"
      - func: "generate SBOM"
      - func: "scan SBOM"
      - func: "augment SBOM"

  # Removed macos x86 as part of SQL-2942
  - name: compile
    depends_on:
      - name: sbom
        variant: code-quality-security
    commands:
      - func: "install iODBC"
        variants: [macos-arm]
      - func: "install rust toolchain"
        variants: [ubuntu2204, windows-64, macos, macos-arm]
      - func: "install unix odbc"
        variants: [ubuntu2204]
      - func: "set and check packages version"
        vars:
          cargo_file: "odbc/Cargo.toml"
          package_name: "odbc"
      - func: "use latest mongosql version"
      - func: "generate third party licenses"
        variants: [ubuntu2204, windows-64, macos, macos-arm]
      - func: "compile ubuntu and win release"
        variants: [ubuntu2204, windows-64]
      - func: "compile macos release"
        variants: [macos-arm]
      - func: "build msi"
        variants: [windows-64]
      - func: "tar linux artifacts"
        variants: [ubuntu2204]
      - func: "build dmg"
        variants: [macos-arm]
      - func: "mciuploads release artifacts"

  - name: unit-test
    commands:
      - func: "install rust toolchain"
        variants: [ubuntu2204, windows-64, macos, macos-arm]
      - func: "install iODBC"
        variants: [macos-arm]
      - func: "install unix odbc"
        variants: [ubuntu2204]
      - func: "run windows unit tests"
        variants: [windows-64]
      - func: "run ubuntu unit tests"
        variants: [ubuntu2204]
      - func: "run ubuntu rfc8252_http_server tests"
        variants: [ubuntu2204]
      - func: "run macos unit tests"
        variants: [macos-arm]

  - name: integration-test
    depends_on:
      - name: compile
    commands:
      - func: "install rust toolchain"
        variants: [ubuntu2204, windows-64, macos, macos-arm]
      - func: "install iODBC"
        variants: [macos-arm]
      - func: "install unix odbc"
        variants: [ubuntu2204]
      - func: "compile release with debug info"
        variants: [ubuntu2204]
      - func: "compile macos release with debug info"
        variants: [macos-arm]
      - func: "setup driver with UnixODBC"
        variants: [ubuntu2204]
      - func: "setup driver with iODBC"
        variants: [macos-arm]
      - func: "prepare resources"
        variants: [windows-64, ubuntu2204]
      - func: "update orchestrator mongod port"
        variants: [windows-64, ubuntu2204]
      - func: "bootstrap mongo-orchestration"
        variants: [windows-64, ubuntu2204]
      - func: "generate sql-engines github token"
        variants: [windows-64, ubuntu2204]
      - func: "decompress testdata files"
        variants: [windows-64, ubuntu2204]
      - func: "run ubuntu integration tests"
        variants: [ubuntu2204]
      - func: "run ubuntu cluster type integration tests"
        variants: [ubuntu2204]
      - func: "run ubuntu mongosqltranslate integration tests"
        variants: [ubuntu2204]
      # Commenting out because the following task only detects
      # memory leaks in the tests
      # - func: "run asan integration tests"
      #   variants: [ ubuntu2204 ]
      - func: "run windows integration tests"
        variants: [windows-64]
      - func: "run macos integration tests"
        variants: [macos-arm]

  - name: asan-unit-tests
    commands:
      - func: "install rust toolchain"
        variants: [ubuntu2204]
      - func: "install unix odbc"
        variants: [ubuntu2204]
      - func: "run asan unit tests"
        variants: [ubuntu2204]

  - name: asan-compile
    commands:
      - func: "install rust toolchain"
        variants: [ubuntu2204]
      - func: "compile ubuntu with asan"
        variants: [ubuntu2204]

  # disabled macos result-set-tests as part of SQL-1688
  - name: result-set-test
    depends_on:
      - name: compile
    commands:
      - func: "install rust toolchain"
        variants: [ubuntu2204, windows-64, macos-arm]
      # - func: "install iODBC"
      #   variants: [macos-arm]
      - func: "install unix odbc"
        variants: [ubuntu2204]
      - func: "compile release with debug info"
        variants: [ubuntu2204]
      # - func: "compile macos release with debug info"
      #   variants: [macos-arm]
      - func: "setup driver with UnixODBC"
        variants: [ubuntu2204]
      # - func: "setup driver with iODBC"
      #   variants: [macos-arm]
      - func: "prepare resources"
        variants: [windows-64, ubuntu2204]
      - func: "update orchestrator mongod port"
        variants: [windows-64, ubuntu2204]
      - func: "bootstrap mongo-orchestration"
        variants: [windows-64, ubuntu2204]
      - func: "generate sql-engines github token"
        variants: [windows-64, ubuntu2204]
      - func: "decompress testdata files"
        variants: [windows-64, ubuntu2204]
      - func: "run windows result set test"
        variants: [windows-64]
      - func: "run ubuntu result-set tests"
        variants: [ubuntu2204]
      # - func: "run macos result-set tests"
      #   variants: [macos-arm]
      # Commenting out because the following task only detects
      # memory leaks in the tests
      # - func: "run asan result-set tests"
      #   variants: [ ubuntu2204 ]

  - name: sign
    allowed_requesters: ["github_tag", "github_merge_queue", "commit"]
    depends_on:
      - name: compile
    commands:
      - func: "fetch for windows sign"
        variants: [windows-64]
      - func: "fetch for ubuntu sign"
        variants: [ubuntu2204]
      - func: "sign windows"
        variants: [windows-64]
      - func: "sign ubuntu and verify signature"
        variants: [ubuntu2204]
      - func: "upload signed windows artifacts"
        variants: [windows-64]
      - func: "upload ubuntu sig file"
        variants: [ubuntu2204]

  - name: snapshot
    depends_on:
      - name: compile
        variant: "*"
      - name: clippy
        variant: "*"
      - name: rustfmt
        variant: "*"
      - name: unit-test
        variant: ".release-variant"
      - name: integration-test
        variant: ".release-variant"
      - name: result-set-test
        variant: ".release-variant"
      - name: sign
        variant: ".release-variant"
    commands:
      - func: "upload release"

  - name: trace-artifacts
    git_tag_only: true
    depends_on:
      - name: release
    commands:
      - func: "trace artifacts"
        vars:
          papertrail_product: "mongo-odbc-driver"

  - name: download-center-update
    git_tag_only: true
    depends_on:
      - name: trace-artifacts
    commands:
      - func: "update download center feed"

  - name: release
    allowed_requesters: ["github_tag", "patch"]
    depends_on:
      - name: compile
        variant: "*"
      - name: sign
        variant: ".release-variant"
    commands:
      - func: "build odbc documentation"
      - func: "upload odbc docs"
      - func: "upload release"

  - name: semgrep
    exec_timeout_secs: 3600 # 1h
    commands:
      - func: "create ssdlc expansions"
      - func: "generate static code analysis"

  - name: ssdlc-artifacts-release
    run_on: ubuntu2204-small
    git_tag_only: true
    depends_on:
      - name: "release"
        variant: "release"
      - name: sbom
        variant: code-quality-security
      - name: semgrep
        variant: code-quality-security
    exec_timeout_secs: 300 # 5m
    commands:
      - func: "create ssdlc expansions"
      - func: "publish static code analysis"
      - func: "publish augmented SBOM"
      - func: "generate compliance report"
        vars:
          release_version: ${release_version}
          repo_name: "mongo-odbc-driver"
          product_name: "Mongo ODBC Driver"
          signing_section_bookmark: "verify-integrity-of-mongodb-odbc-driver-packages"
      - func: "publish compliance report"

  - name: ssdlc-artifacts-snapshot
    run_on: ubuntu2204-small
    allow_for_git_tag: false
    depends_on:
      - name: sbom
        variant: code-quality-security
      - name: semgrep
        variant: code-quality-security
    exec_timeout_secs: 300 # 5m
    commands:
      - func: "create ssdlc expansions"
      - func: "publish static code analysis"
      - func: "publish augmented SBOM"
      - func: "generate compliance report"
        vars:
          release_version: ${release_version}
          repo_name: "mongo-odbc-driver"
          product_name: "Mongo ODBC Driver"
          signing_section_bookmark: "verify-integrity-of-mongodb-odbc-driver-packages"
      - func: "publish compliance report"

task_groups:
  - name: windows-windows-test-unit-group
    setup_group_can_fail_task: false
    setup_group:
      - func: "fetch source"
      - func: "generate expansions"
    tasks:
      - unit-test

  - name: windows-test-integration-group
    setup_group_can_fail_task: false
    setup_group:
      - func: "fetch source"
      - func: "generate expansions"
      - func: "download artifact"
      - func: "setup driver on Windows"
      - func: "setup crash dump collection"
    teardown_group:
      - func: "upload crash debugging info"
      - func: "clean-up driver on Windows"
      - func: "clean-up crash dump collection"
    tasks:
      - integration-test

  - name: windows-test-result-set-group
    setup_group_can_fail_task: false
    setup_group:
      - func: "fetch source"
      - func: "generate expansions"
      - func: "download artifact"
      - func: "setup driver on Windows"
      - func: "setup crash dump collection"
    teardown_group:
      - func: "upload crash debugging info"
      - func: "clean-up driver on Windows"
      - func: "clean-up crash dump collection"
    tasks:
      - result-set-test

buildvariants:
  - name: static-analysis
    display_name: "* Static Analysis"
    run_on: [ubuntu2004-test]
    modules:
      - sql-engines-common-test-infra
    tasks:
      - name: clippy
      - name: rustfmt
      - name: unused-dependencies
      - name: asan-compile

  - name: code-quality-security
    display_name: "Code Quality and Security"
    run_on: [ubuntu2204-small]
    modules:
      - sql-engines-common-test-infra
    tasks:
      - name: semgrep
      - name: sbom
      - name: ssdlc-artifacts-snapshot

  - name: windows-64
    tags: ["release-variant"]
    display_name: Windows (64-bit)
    run_on: [windows-2022-large]
    modules:
      - sql-engines-common-test-infra
    tasks:
      - name: compile
      - name: windows-windows-test-unit-group
      - name: windows-test-integration-group
      - name: windows-test-result-set-group
      - name: sign
        run_on: ubuntu2204-large

  - name: ubuntu2204
    tags: ["release-variant"]
    display_name: Ubuntu 22.04
    run_on: [ubuntu2204-large]
    modules:
      - sql-engines-common-test-infra
    tasks:
      - name: compile
      - name: unit-test
      - name: integration-test
      - name: result-set-test
      - name: asan-unit-tests
      - name: sign

  - name: macos-arm
    display_name: "macOS arm64"
    run_on: [macos-13-arm64]
    modules:
      - sql-engines-common-test-infra
    tasks:
      - name: compile
      - name: unit-test
      # SQL-1841: Investigate iodbc hanging with odbc 2 integration tests
      # - name: integration-test
      - name: result-set-test

  - name: release
    display_name: "Release"
    run_on: [ubuntu2004-medium]
    modules:
      - sql-engines-common-test-infra
    tasks:
      - name: make-odbc-docs
      - name: release
      - name: snapshot
      - name: trace-artifacts
      - name: download-center-update
      - name: ssdlc-artifacts-release
